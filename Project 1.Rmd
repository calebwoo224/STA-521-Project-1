---
title: "Project 1"
author: "Sanskriti Purohit & Caleb Woo"
date: "2022-10-13"
output: pdf_document
---

```{r chunk-options}
knitr::opts_chunk$set(message = F, warning = F)
```

```{r libraries-data}
library(tidyverse)
library(dplyr)
library(chron)
library(lubridate)
library(ggcorrplot)
data_net <- read.csv("data/sonoma-data-net.csv")
data_log <- read.csv("data/sonoma-data-log.csv")
```

```{r dates}
dates <- read.table("data/sonoma-dates", sep = " ")
dates <- data.frame(t(dates)[-2,], row.names = NULL)
names(dates) <- dates[1,]
dates <- dates[-1,]
dates <- dates[-13001,]
dates[1,] <- c("1",	"Tue Apr 27 17:10:00 2004",	"12536.0069444444")
row.names(dates) <- NULL

dates <- dates %>%
  mutate(epochNums = as.integer(epochNums),
         epochDates = as.POSIXct(epochDates, format = "%a %b %d %H:%M:%S %Y"),
         epochDays = as.numeric(epochDays))
names(dates)[1] <- "epoch"
```

## 2.

### a)

Voltage

```{r initial-voltage}
data_net %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=25) +
  labs(title="Network ADC Histogram", x="ADC", y="Count")

data_log %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Logs Voltage Histogram", x="Voltage", y="Count")
```

Voltage is inconsistent, link below for ADC to voltage conversion

  - http://www-db.ics.uci.edu/pages/research/quasar/MPR-MIB%20Series%20User%20Manual%207430-0021-06_A.pdf
  
  - page 23 (25 of pdf) has MICA2DOT conversion

```{r fixed-voltage}
data_net <- data_net %>%
  mutate(voltage = 0.6*(1024/voltage))

data_net %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Network Voltage Histogram", x="Voltage", y="Count")

data_log %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Logs Voltage Histogram", x="Voltage", y="Count")
```

Humidity

```{r humidity}
data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  select(humidity) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  select(humidity) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4 & humidity < 105) %>%
  select(humidity) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  select(humidity) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4 & humidity < 105) %>%
  ggplot(data=., aes(x=humidity)) +
  geom_histogram(bins=20) +
  labs(title="Network Humidity Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humidity)) +
  geom_histogram(bins=20) +
  labs(title="Logs Humidity Histogram", x="Humidity", y="Count")
```

Adjusted Humidity

```{r adj-humidity}
data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_adj) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_adj) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4 & humid_adj < 105) %>%
  select(humid_adj) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_adj) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4 & humid_adj < 105) %>%
  ggplot(data=., aes(x=humid_adj)) +
  geom_histogram(bins=20) +
  labs(title="Network Adjusted Humidity Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humid_adj)) +
  geom_histogram(bins=20) +
  labs(title="Logs Adjusted Humidity Histogram", x="Humidity", y="Count")
```

Temperature

```{r temperature}
data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_temp) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_temp) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4 & humid_temp < 35) %>%
  select(humid_temp) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_temp) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4 & humid_temp < 35) %>%
  ggplot(data=., aes(x=humid_temp)) +
  geom_histogram(bins=15) +
  labs(title="Network Temperature Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humid_temp)) +
  geom_histogram(bins=15) +
  labs(title="Logs Temperature Histogram", x="Humidity", y="Count")
```

Incident PAR

```{r initial-hamatop}
data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  max()
```

Hamatop is inconsistent, link below for Lux to PPFD conversion

  - https://www.apogeeinstruments.com/conversion-ppfd-to-lux/

```{r fixed-hamatop}
data_net <- data_net %>%
  mutate(hamatop=0.0185*hamatop)

data_log <- data_log %>%
  mutate(hamatop=0.0185*hamatop)

data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4 & hamatop < 2200) %>%
  select(hamatop) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Network Incident PAR Histogram", x="Incident PAR", y="Count")

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4  & hamatop < 2200) %>%
  ggplot(data=., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Logs Incident PAR Histogram", x="Incident PAR", y="Count")
```

Reflected PAR

```{r initial-hamabot}
data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()
```

Fix hamabot like hamatop

```{r fixed-hamabot}
data_net <- data_net %>%
  mutate(hamabot=0.0185*hamabot)

data_log <- data_log %>%
  mutate(hamabot=0.0185*hamabot)

data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=hamabot)) +
  geom_histogram(bins=15) +
  labs(title="Network Reflected PAR Histogram", x="Reflected PAR", y="Count")

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=hamabot)) +
  geom_histogram(bins=15) +
  labs(title="Logs Reflected PAR Histogram", x="Reflected PAR", y="Count")
```

### b)

```{r dates-merge}
data_both <- merge(data_net, data_log, by = c("epoch", "nodeid"), all.y = T, suffixes = c(".net", ".log"))
data_all <- merge(data_both, dates, by = "epoch", all.x = T)
```

```{r missing}
missing_data <-  data_all %>%
  select(ends_with(".log"), epochDates, epochDays) %>%
  filter_all(any_vars(is.na(.)))
  #filter(is.na(parent.log) | is.na(voltage.log) | is.na(depth.log) | is.na(humidity.log) | is.na(humid_temp.log) |
  #       is.na(humid_adj.log) | is.na(hamatop.log) | is.na(hamabot.log))

paste0("# of missing measurements: ", nrow(missing_data))

missing_data %>%
  select(epochDates) %>%
  summarise(min = min(epochDates),
            max = max(epochDates))
```

```{r remove-missing}
data_all <- data_all %>%
  filter(!is.na(parent.log) & !is.na(voltage.log) & !is.na(depth.log) & !is.na(humidity.log) & !is.na(humid_temp.log) &
         !is.na(humid_adj.log) & !is.na(hamatop.log) & !is.na(hamabot.log))
row.names(data_all) <- NULL
```

### c)

```{r locations}
locations <- read.table("data/mote-location-data.txt")
names(locations) <- locations[1,]
names(locations)[1] <- "nodeid"
locations <- data.frame(locations[-1,])
row.names(locations) <- NULL
```

```{r locations-merge}
data_all <- merge(data_all, locations, by = "nodeid", all.x = T)
```

The network data and logs data have identical columns in this merged data frame except for voltage. This must be because network voltage data had to be converted from ADC so the conversion may not be exact. Since network data is missing for some rows, logs data is not missing for any rows, and logs data has identical values as network data (other than voltage but logs voltage is more accurate anyways), we can remove network data columns from the merged data frame. In addition, result_time and epochDates represent the same information with epochDates from sonoma-dates being more accurate, so I will also remove the result_time column from the logs data.

```{r remove-network-data}
data_all <- data_all %>%
  select(-ends_with(".net"), -result_time.log)
names(data_all)[3:11] <- str_replace(names(data_all)[3:11], ".log", "")
names(data_all)
```

There are 16 total variables in my complete merged data frame that includes network and logs data, dates data, and locations data.

### d)

Since sensors with low batteries were not accurate, we removed all data with voltages greater than 3 and less than 2.4 like Tolle et al. Below are the quantiles and histograms of each variable after removing the voltages and before removing any other outliers.

```{r voltage-outliers}
data_all <- data_all %>%
  filter(voltage <= 3 & voltage >= 2.4)
```

```{r humidity-pre-removal}
quantile(data_all$humidity)

data_all %>%
  ggplot(., aes(x=humidity)) +
  geom_histogram()
```

```{r humid_adj-removal}
quantile(data_all$humid_adj)

data_all %>%
  ggplot(., aes(x=humid_adj)) +
  geom_histogram()
```

The quantiles in humid_adj more closely matches that of Tolle et al. compared to the quantiles of humidity so we should use humid_adj in place of humidity. This allows us to remove 1 more variable so we have a total of 15 variables. There do not seem to be any other outliers in humid_adj.

```{r temp-pre-removal}
quantile(data_all$humid_temp)

data_all %>%
  ggplot(., aes(x=humid_temp)) +
  geom_histogram()
```

The quantiles of temperature match up well with that of Tolle et al. so there does not seem to be any other outliers in temperature.

```{r hamatop-pre-removal}
quantile(data_all$hamatop)

data_all %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram()
```

```{r high-hamatop-nodes}
data_all %>%
  filter(hamatop > 2154) %>%
  select(nodeid) %>%
  unique()
```

There seem to be some abnormally high values of incident PAR and when we look for the nodes that gave a reading higher than the max incident PAR reading of 2154 given in the paper, we see that node 40 is solely responsible for all those readings. So we will remove all observations with node 40.

```{r hamabot-pre-removal}
quantile(data_all$hamabot)

data_all %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram()
```

The quantiles of reflected PAR match up well with that of Tolle et al. so there does not seem to be any other outliers in reflected PAR.

Below are the quantiles and histograms of each variable after removing both the voltages and observations with node 40. 

```{r remove-node-40}
data_all <- data_all %>%
  filter(nodeid != 40)
```

```{r humid-adj-post-removal}
quantile(data_all$humid_adj)

data_all %>%
  ggplot(., aes(x=humid_adj)) +
  geom_histogram()
```

```{r temp-post-removal}
quantile(data_all$humid_temp)

data_all %>%
  ggplot(., aes(x=humid_temp)) +
  geom_histogram()
```

```{r hamatop-post-removal}
quantile(data_all$hamatop)

data_all %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram()
```

```{r hamabot-post-removal}
quantile(data_all$hamabot)

data_all %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram()
```

All quantiles and histograms of humidity, temperature, incident PAR, and reflected PAR match up well with the quantiles of Tolle et al. after removing observations with voltages greater than 3 and less than 2.4 and removing observations with node 40.

```{r write-csv-data-all}
data_all <- read_csv("data/data-all-dates-locations.csv")
data_all <- data_all %>%
  filter(!is.na(Height) & !is.na(Direc) & !is.na(Dist) & !is.na(Tree))
#write.csv(data_all, "data/data-all-dates-locations.csv")
```

```{r}
#Checking for further outliers
data_all %>%
  ggplot(., aes(x=voltage))+geom_boxplot()
data_all %>%
  ggplot(., aes(x=humid_temp))+geom_boxplot()
```

## 3.

### a)
```{r}
data_all = read.csv("data/data-all-dates-locations.csv")
data_all %>%
  select(epochDates) %>%
  summarise(
    min = min(epochDates),
    max = max(epochDates)
  )

data_all$Date = as.Date(data_all$epochDates)
data_all$time = format(as.POSIXct(data_all$epochDates), format = "%H:%M")
data_all$dayofweek = wday(data_all$epochDates)
data_all$hour = format(as.POSIXct(data_all$epochDates), format = "%H")
data_all$hour = as.numeric(data_all$hour)
# data_all$Height = as.numeric(data_all$Height) #Check this
#Reason for choosing the hours for Dark and Light
data_all %>% 
  ggplot(aes(x=hour,y=hamatop)) + geom_point()
data_all$Sunlight = case_when(
  as.numeric(data_all$hour) <= 5 | as.numeric(data_all$hour) >= 20  ~ "Dark",
  as.numeric(data_all$hour) < 20 ~ "Light"
)
count(data_all,Sunlight)

date_count = data_all %>% 
  count(Date)
date_count$n = date_count$n*100/sum(date_count$n)
p=0
for(i in 1:length(date_count$n)){
  p = p + date_count$n[i]
  date_count$n[i] = p
}
date_count$n
data_all = data_all %>%
  filter(Date > '2004-04-27' & Date < '2004-05-27')
data_all %>%
  select(epochDates) %>%
  summarise(
    min = min(epochDates),
    max = max(epochDates)
  )
count(data_all,Sunlight)

#Add more?
data_all %>% 
  ggplot(aes(x=humid_temp, y=humid_adj, col = Sunlight)) + geom_point()
data_all %>% 
  ggplot(aes(x=hour,y=hamatop)) + geom_point()
data_all %>%
  ggplot(aes(x=hour,y=hamatop, col=Height)) + geom_point()
data_all %>%
  ggplot(aes(x=humid_temp,y=hamatop)) + geom_point()
data_all %>% 
  ggplot(aes(x=humid_adj,y=hamabot, col = Sunlight)) + geom_point()
data_all %>% 
  ggplot(aes(x=humid_temp,y=hamabot, col=Sunlight)) + geom_point()
#Abnormal values of reflected ray at odd hours at higher levels of heights.
data_all %>% 
  ggplot(aes(x=hour,y=hamabot)) + geom_point()
```
## 3
### b)
```{r}
#Positive correlation only between hamatop and hamabot?
corr = round(x=cor(data_all[,unlist(lapply(data_all,is.numeric))],y=data_all$hamatop, method=c("pearson","kendall","spearman")))
ggcorrplot(corr,method="square")
```
### c)
```{r}
names(data_all)
cols_name = c("hamatop","hamabot","Height","hour","dayofweek","humid_temp","humid_adj")
data_filtered = data_all |>
  select(all_of(cols_name)) |>
  data.frame()
pca_prcomp = prcomp(data_filtered, scale. = TRUE)
summary(pca_prcomp)
eigenvalues = pca_prcomp$sdev**2
plot(1:length(eigenvalues), eigenvalues/sum(eigenvalues), type = "l")
points(1:length(eigenvalues), eigenvalues/sum(eigenvalues))
```