---
title: "Project 1"
author: "Sanskriti Purohit & Caleb Woo"
date: "2022-10-13"
output: pdf_document
---
```{r chunk-options, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```
```{r libraries-data, include=FALSE}
library(tidyverse)
library(dplyr)
library(chron)
library(lubridate)
library(ggcorrplot)
library(RColorBrewer)
library(scales)
library(kableExtra)
library(gridExtra)
library(factoextra)
data_net <- read.csv("data/sonoma-data-net.csv")
data_log <- read.csv("data/sonoma-data-log.csv")
# find dates cleaning in "dates-cleaning.R"
dates <- read_csv("data/dates.csv")
dates <- dates %>%
  select(-c("...1"))
```

## 2. Data cleaning

Voltage is our first inconsistent variable. We see that the network data voltage is in ADC units in the left plot while the log data voltage is in volts in the middle plot. Tolle et al. uses volts as the voltage unit, so we converted the network data voltage units from ADC to volts using the MICA2DOT user's manual found at this link: http://www-db.ics.uci.edu/pages/research/quasar/MPR-MIB%20Series%20User%20Manual%207430-0021-06_A.pdf.

In section 6.5 of the user's manual, we see that we can convert ADC to volts by using the following formula:

$$\text{Voltage} = 0.6*\frac{1024}{ADC}$$

The histogram of the fixed network data voltage in volts is seen in the right plot.

```{r initial-voltage}
net_initial_voltage <- data_net %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=25) +
  labs(title="Network ADC", x="ADC", y="Count")

log_initial_voltage <- data_log %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Log Voltage", x="Volts", y="Count")

data_net <- data_net %>%
  mutate(voltage = 0.6*(1024/voltage))

net_fixed_voltage <- data_net %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Network Voltage", x="Volts", y="Count")

grid.arrange(net_initial_voltage, log_initial_voltage, net_fixed_voltage, nrow=1)
```

Incident PAR is our second inconsistent variable. In the top two plots, we see that both network data incident PAR and log data incident PAR are represented as illuminance in lux units rather than as the photosyntehtic photon flux density (PPFD) in micromoles per second per meter squared units used in the paper. So we converted illuminance to PPFD using Apogee Instrument's conversion table found at this link: https://www.apogeeinstruments.com/conversion-ppfd-to-lux/.

In the table on the right hand side, we see that we can convert illuminance in lux to PPFD in micromoles per second per meter squared for sunlight measurements by using the following formula:

$$\text{PPFD} = 0.0185*\text{illuminance}$$

The histograms of the fixed network and log incident PAR as PPFD in micromoles per second per meter squared is shown in the bottom two plots.

```{r initial-hamatop}
net_initial_hamatop <- data_net %>%
  filter(!is.na(hamatop)) %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Network Incident PAR", x="Lux", y="Count")

log_initial_hamatop <- data_log %>%
  filter(!is.na(hamatop)) %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Log Incident PAR", x="Lux", y="Count")

data_net <- data_net %>%
  mutate(hamatop=0.0185*hamatop)

data_log <- data_log %>%
  mutate(hamatop=0.0185*hamatop)

net_fixed_hamatop <- data_net %>%
  filter(!is.na(hamatop)) %>%
  ggplot(data=., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Network Incident PAR", x="\u00b5mol/m\u00b2/s", y="Count")

log_fixed_hamatop <- data_log %>%
  filter(!is.na(hamatop)) %>%
  ggplot(data=., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Log Incident PAR", x="\u00b5mol/m\u00b2/s", y="Count")

grid.arrange(net_initial_hamatop, log_initial_hamatop, net_fixed_hamatop, log_fixed_hamatop, nrow=2, ncol=2)
```

Similarly for reflected PAR, both network data reflected PAR and log data reflected PAR are represented as illuminance in lux units rather than as the PPFD in micromoles per second per meter squared units used in the paper. So we converted reflected PAR just like how we converted incident PAR above. The top two plots below show the histograms of network and log reflected PAR in lux prior to the conversion. The bottom two plots show the histograms of network and log reflected PAR in micromoles per second per meter squared after the conversion.

```{r initial-hamabot}
net_initial_hamabot <- data_net %>%
  filter(!is.na(hamabot)) %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram(bins=20) +
  labs(title="Network Reflected PAR", x="Lux", y="Count")

log_initial_hamabot <- data_log %>%
  filter(!is.na(hamabot)) %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram(bins=20) +
  labs(title="Log Reflected PAR", x="Lux", y="Count")

data_net <- data_net %>%
  mutate(hamabot=0.0185*hamabot)

data_log <- data_log %>%
  mutate(hamabot=0.0185*hamabot)

net_fixed_hamabot <- data_net %>%
  filter(!is.na(hamabot)) %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram(bins=20) +
  labs(title="Network Reflected PAR", x="\u00b5mol/m\u00b2/s", y="Count")

log_fixed_hamabot <- data_log %>%
  filter(!is.na(hamabot)) %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram(bins=20) +
  labs(title="Log Reflected PAR", x="\u00b5mol/m\u00b2/s", y="Count")

grid.arrange(net_initial_hamabot, log_initial_hamabot, net_fixed_hamabot, log_fixed_hamabot, nrow=2, ncol=2)
```

The other two relevant variables, humidity and temperature, appear to be consistent with each other and with the units used in the paper. Temperature is in degrees Celsius while humidity is in percent of relative humidity.
```{r humidity, include=FALSE}
# unused humidity and temperature histograms
data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4 & humidity < 105) %>%
  ggplot(data=., aes(x=humidity)) +
  geom_histogram(bins=20) +
  labs(title="Network Humidity Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humidity)) +
  geom_histogram(bins=20) +
  labs(title="Logs Humidity Histogram", x="Humidity", y="Count")
```
```{r adj-humidity, include=FALSE}
data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4 & humid_adj < 105) %>%
  ggplot(data=., aes(x=humid_adj)) +
  geom_histogram(bins=20) +
  labs(title="Network Adjusted Humidity Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humid_adj)) +
  geom_histogram(bins=20) +
  labs(title="Logs Adjusted Humidity Histogram", x="Humidity", y="Count")
```
```{r temperature, include=FALSE}
data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4 & humid_temp < 35) %>%
  ggplot(data=., aes(x=humid_temp)) +
  geom_histogram(bins=15) +
  labs(title="Network Temperature Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humid_temp)) +
  geom_histogram(bins=15) +
  labs(title="Logs Temperature Histogram", x="Humidity", y="Count")
```

After we made all relevant variables in the network and log data consistent with each other and with the units used in the paper, we combined their data and also merged this combined data with the dates information found in "sonoma-dates". There are 8760 observations with missing measurements and these missing observations occur between April 30 at 8:05 AM and May 25 at 9:15 PM inclusive. We removed these 8760 missing observations.

```{r dates-merge}
data_both <- merge(data_net, data_log, by = c("epoch", "nodeid"), all.y = T, suffixes = c(".net", ".log"))
data_all <- merge(data_both, dates, by = "epoch", all.x = T)
```
```{r missing}
missing_data <-  data_all %>%
  select(ends_with(".log"), epochDates, epochDays) %>%
  filter_all(any_vars(is.na(.)))
  #filter(is.na(parent.log) | is.na(voltage.log) | is.na(depth.log) | is.na(humidity.log) | is.na(humid_temp.log) |
  #       is.na(humid_adj.log) | is.na(hamatop.log) | is.na(hamabot.log))

#paste0("# of missing measurements: ", nrow(missing_data))

missing_data %>%
  select(epochDates) %>%
  summarise(Start = min(epochDates),
            End = max(epochDates)) %>%
  kbl(caption = "8760 Missing Observations Time Period") %>%
  kable_styling(latex_options = "HOLD_position", full_width = F)
```
```{r remove-missing}
data_all <- data_all %>%
  filter(!is.na(parent.log) & !is.na(voltage.log) & !is.na(depth.log) & !is.na(humidity.log) & !is.na(humid_temp.log) &
         !is.na(humid_adj.log) & !is.na(hamatop.log) & !is.na(hamabot.log))
row.names(data_all) <- NULL
```

When we initially combined the network data and log data, we noticed that they essentially have identical columns except for voltage. This must be because network voltage data had to be converted from ADC to volts so the conversion may not be exact. Since network data is missing for some rows, log data is not missing for any rows, and log data has essentially identical values as network data (other than voltage but log data voltage is more accurate anyways), we removed network data columns from the combined data frame. In addition, the result_time column from the combined data and the epochDates column merged from the dates information found in "sonoma-dates" represent the same information. However, epochDates from "sonoma-dates" is more accurate so we also removed the result_time column from the combined and merged data. Finally, I merged the locations data found in "mote-location-data.txt" with the rest of the combined and merged data described above to get a total of 16 variables that includes network and log data, dates data, and locations data. After merging the locations data, we found that there are 6091 observations with missing values in the locations data so we removed these observations as well.
```{r locations, include=FALSE}
# find locations cleaning in "locations-cleaning.R"
locations <- read_csv("data/locations.csv") %>%
  select(-c("...1"))
```
```{r locations-merge}
data_all <- merge(data_all, locations, by = "nodeid", all.x = T)
```
```{r remove-network-data}
data_all <- data_all %>%
  select(-ends_with(".net"), -result_time.log)
names(data_all)[3:11] <- str_replace(names(data_all)[3:11], ".log", "")
```
```{r remove-missing-locations}
#data_all %>%
#  filter(is.na(Height) & is.na(Direc) & is.na(Dist) & is.na(Tree)) %>%
#  nrow()
data_all <- data_all %>%
  filter(!is.na(Height) & !is.na(Direc) & !is.na(Dist) & !is.na(Tree))
```

Since Tolle et al. found a correlation between battery failure and outliers, we first utilized their automatic outlier rejection strategy to get rid of most outliers before investigating for further outliers. We removed all data with voltages greater than 3 volts and less than 2.4 volts as described by Tolle et al. This removed 26,011 observations from our data.

Below are the quantiles of humidity, adjusted humidity, temperature, incident PAR, and reflected PAR after removing outlier voltages. While the quantiles of humidity and adjusted humidity are very similar, the maximum value of adjusted humidity at 100.223 is closer to the maximum humidity value of 100.2 found in the paper so we will use adjusted humidity as our humidity measurement going forward. Below the quantiles are histograms of the four relevant variables. Comparing the quantiles of incident PAR with the quantiles of the paper and visually inspecting the incident PAR histogram revealed that there are some abnormally high values of incident PAR. Looking at the observations with an incident PAR higher than the maximum incident PAR of 2154 given in the paper, we found that node 40 is solely responsible for all of those readings. So we removed all observations recorded by node 40 to remove incident PAR outliers. Comparing the other quantiles with the quantiles in the paper and visually inspecting the other histograms do not reveal any further noticeable outliers in adjusted humidity, temperature, and reflected PAR.

```{r voltage-outliers}
#data_all %>%
#  filter(voltage > 3 | voltage < 2.4) %>%
#  nrow()
data_all <- data_all %>%
  filter(voltage <= 3 & voltage >= 2.4)
```
```{r quantiles-pre-removal}
pre_humidity <- as.data.frame(quantile(data_all$humidity))
names(pre_humidity)[1] <- "Humidity"
pre_humid_adj <- as.data.frame(quantile(data_all$humid_adj))
names(pre_humid_adj)[1] <- "Adjusted Humidity"
pre_humid_temp <- as.data.frame(quantile(data_all$humid_temp))
names(pre_humid_temp)[1] <- "Temperature"
pre_hamatop <- as.data.frame(quantile(data_all$hamatop))
names(pre_hamatop)[1] <- "Incident PAR"
pre_hamabot <- as.data.frame(quantile(data_all$hamabot))
names(pre_hamabot)[1] <- "Reflected PAR"

cbind(pre_humidity, pre_humid_adj, pre_humid_temp, pre_hamatop, pre_hamabot) %>%
  kbl(digits = 3, caption = "Quantiles After Removing Outlier Voltages") %>%
  kable_styling(latex_options = "HOLD_position", full_width = F)
```
```{r histograms-pre-removal}
pre_humid_adj_hist <- data_all %>%
  ggplot(., aes(x=humid_adj)) +
  geom_histogram(binwidth=5) +
  labs(title="Adjusted Humidity", x="%RH", y="Count")

pre_humid_temp_hist <- data_all %>%
  ggplot(., aes(x=humid_temp)) +
  geom_histogram(binwidth=2) +
  labs(title="Temperature", x="\u00b0C", y="Count")

pre_hamatop_hist <- data_all %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram(binwidth=100) +
  labs(title="Incident PAR", x="\u00b5mol/m\u00b2/s", y="Count")

pre_hamabot_hist <- data_all %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram(binwidth=10) +
  labs(title="Reflected PAR", x="\u00b5mol/m\u00b2/s", y="Count")

grid.arrange(pre_humid_adj_hist, pre_humid_temp_hist, pre_hamatop_hist, pre_hamabot_hist, nrow=2, ncol=2)
```
```{r high-hamatop-nodes}
#data_all %>%
#  filter(hamatop > 2154) %>%
#  select(nodeid) %>%
#  unique()
```
```{r remove-node-40}
#data_all %>%
#  filter(nodeid == 40) %>%
#  nrow()
data_all <- data_all %>%
  filter(nodeid != 40)
```

Below are the quantiles and histograms of the relevant variables after removing outlier voltages and removing node 40. The quantiles match up well with the quantiles found in the paper and the histograms do not reveal any further noticeable outliers. Removing node 40 resulted in removing 98 observations recorded by node 40. Therefore, the final number of observations after all data cleaning is 271,776. Considering that log data contained 301,056 observations and network data contained 114,980 observations, our final cleaned data retains most of the information found in the log and network data.

```{r quantiles-post-removal}
post_humid_adj <- as.data.frame(quantile(data_all$humid_adj))
names(post_humid_adj)[1] <- "Adjusted Humidity"
post_humid_temp <- as.data.frame(quantile(data_all$humid_temp))
names(post_humid_temp)[1] <- "Temperature"
post_hamatop <- as.data.frame(quantile(data_all$hamatop))
names(post_hamatop)[1] <- "Incident PAR"
post_hamabot <- as.data.frame(quantile(data_all$hamabot))
names(post_hamabot)[1] <- "Reflected PAR"

cbind(post_humid_adj, post_humid_temp, post_hamatop, post_hamabot) %>%
  kbl(digits = 3, caption = "Quantiles After Removing Node 40") %>%
  kable_styling(latex_options = "HOLD_position", full_width = F)
```
```{r histograms-post-removal}
post_humid_adj_hist <- data_all %>%
  ggplot(., aes(x=humid_adj)) +
  geom_histogram(binwidth=5) +
  labs(title="Adjusted Humidity", x="%RH", y="Count")

post_humid_temp_hist <- data_all %>%
  ggplot(., aes(x=humid_temp)) +
  geom_histogram(binwidth=2) +
  labs(title="Temperature", x="\u00b0C", y="Count")

post_hamatop_hist <- data_all %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram(binwidth=100) +
  labs(title="Incident PAR", x="\u00b5mol/m\u00b2/s", y="Count")

post_hamabot_hist <- data_all %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram(binwidth=10) +
  labs(title="Reflected PAR", x="\u00b5mol/m\u00b2/s", y="Count")

grid.arrange(post_humid_adj_hist, post_humid_temp_hist, post_hamatop_hist, post_hamabot_hist, nrow=2, ncol=2)
```
```{r write-csv-data-all}
#data_all %>%
#  filter_all(any_vars(is.na(.))) %>%
#  nrow()

#write.csv(data_all, "data/data-all-dates-locations.csv")
```

## 3.

### a)
```{r}
data_all = read.csv("data/data-all-dates-locations.csv")
data_all %>%
  select(epochDates) %>%
  summarise(
    min = min(epochDates),
    max = max(epochDates)
  )

data_all$Date = as.Date(data_all$epochDates)
data_all$time = format(as.POSIXct(data_all$epochDates), format = "%H:%M")
data_all$dayofweek = wday(data_all$epochDates)
data_all$hour = format(as.POSIXct(data_all$epochDates), format = "%H")
data_all$hour = as.numeric(data_all$hour)
# data_all$Height = as.numeric(data_all$Height) #Check this
#Reason for choosing the hours for Dark and Light
data_all %>% 
  ggplot(aes(x=hour,y=hamatop)) + geom_point()
data_all$Sunlight = case_when(
  as.numeric(data_all$hour) <= 5 | as.numeric(data_all$hour) >= 20  ~ "Dark",
  as.numeric(data_all$hour) < 20 ~ "Light"
)
count(data_all,Sunlight)

date_count = data_all %>% 
  count(Date)
date_count$n = date_count$n*100/sum(date_count$n)
p=0
for(i in 1:length(date_count$n)){
  p = p + date_count$n[i]
  date_count$n[i] = p
}
date_count$n
data_all = data_all %>%
  filter(Date > '2004-04-27' & Date < '2004-05-27')
data_all %>%
  select(epochDates) %>%
  summarise(
    min = min(epochDates),
    max = max(epochDates)
  )
count(data_all,Sunlight)

#Add more?
data_all %>% 
  ggplot(aes(x=humid_temp, y=humid_adj, col = Sunlight)) + geom_point(alpha=0.05)
data_all %>%
  ggplot(aes(x=hour,y=hamatop)) + geom_point()
data_all %>%
  ggplot(aes(x=humid_temp,y=hamatop,col=Sunlight)) + geom_point(alpha=0.05)
data_all %>%
  ggplot(aes(x=humid_adj,y=hamatop,col=Sunlight)) + geom_point(alpha=0.05)
data_all %>% 
  ggplot(aes(x=humid_adj,y=hamabot, col = Sunlight)) + geom_point(alpha=0.05)
data_all %>% 
  ggplot(aes(x=humid_temp,y=hamabot, col=Sunlight)) + geom_point(alpha=0.05)
#Abnormal values of reflected ray at odd hours at higher levels of heights.
data_all %>% 
  ggplot(aes(x=hour,y=hamabot)) + geom_point()
```
## 3
### b)
```{r}
corr =x=cor(data_all[,unlist(lapply(data_all,is.numeric))],y=data_all$hamatop, method=c("pearson","kendall","spearman"))
ggcorrplot(corr,method="square")
```

### c)
```{r}
data_all %>%
  group_by(Date,Height)%>%
  summarise(avg_hamatop = mean(hamatop),.groups="drop") %>%
  ggplot(aes(x=Date,y=avg_hamatop,col=Height,group=Height))+ geom_line()+scale_x_date(breaks="4 days",date_labels = "%B %d")
data_all %>%
  group_by(Date,Height)%>%
  summarise(avg_hamabot = mean(hamabot),.groups="drop") %>%
  ggplot(aes(x=Date,y=avg_hamabot,col=Height,group=Height)) + geom_line()+scale_x_date(breaks="4 days",date_labels = "%B %d")
data_all %>%
  group_by(Date,Height)%>%
  summarise(avg_humid = mean(humid_adj),.groups="drop") %>%
  ggplot(aes(x=Date,y=avg_humid,col=Height,group=Height)) + geom_line()+scale_x_date(breaks="4 days",date_labels = "%B %d")
data_all %>%
  group_by(Date,Height)%>%
  summarise(avg_temp = mean(humid_temp),.groups="drop") %>%
  ggplot(aes(x=Date,y=avg_temp,col=Height,group=Height)) + geom_line()+scale_x_date(breaks="4 days",date_labels = "%B %d")


data_all %>%
  group_by(dayofweek,Height)%>%
  summarise(avg_hamatop = mean(hamatop),.groups="drop") %>%
  ggplot(aes(x=dayofweek,y=avg_hamatop,col=Height,group=Height))+ geom_line()
data_all %>%
  group_by(dayofweek,Height)%>%
  summarise(avg_hamabot = mean(hamabot),.groups="drop") %>%
  ggplot(aes(x=dayofweek,y=avg_hamabot,col=Height,group=Height)) + geom_line()
data_all %>%
  group_by(dayofweek,Height)%>%
  summarise(avg_humid = mean(humid_adj),.groups="drop") %>%
  ggplot(aes(x=dayofweek,y=avg_humid,col=Height,group=Height)) + geom_line()
data_all %>%
  group_by(dayofweek,Height)%>%
  summarise(avg_temp = mean(humid_temp),.groups="drop") %>%
  ggplot(aes(x=dayofweek,y=avg_temp,col=Height,group=Height)) + geom_line()


data_all %>%
  group_by(hour,Height)%>%
  summarise(avg_hamatop = mean(hamatop),.groups="drop") %>%
  ggplot(aes(x=hour,y=avg_hamatop,col=Height,group=Height))+ geom_line()
data_all %>%
  group_by(hour,Height)%>%
  summarise(avg_hamabot = mean(hamabot),.groups="drop") %>%
  ggplot(aes(x=hour,y=avg_hamabot,col=Height,group=Height)) + geom_line()
data_all %>%
  group_by(hour,Height)%>%
  summarise(avg_humid = mean(humid_adj),.groups="drop") %>%
  ggplot(aes(x=hour,y=avg_humid,col=Height,group=Height)) + geom_line()
data_all %>%
  group_by(hour,Height)%>%
  summarise(avg_temp = mean(humid_temp),.groups="drop") %>%
  ggplot(aes(x=hour,y=avg_temp,col=Height,group=Height)) + geom_line()
```
### d)
```{r}
names(data_all)
cols_name = c("hamatop","hamabot","Height","humid_temp","humid_adj","hour","dayofweek")
data_filtered = data_all |>
  select(all_of(cols_name)) |>
  data.frame()
pca_prcomp = prcomp(data_filtered, scale. = TRUE)
summary(pca_prcomp)
eigenvalues = pca_prcomp$sdev**2
plot(1:length(eigenvalues), eigenvalues/sum(eigenvalues), type = "l")
points(1:length(eigenvalues), eigenvalues/sum(eigenvalues))
```

## 4
Through the k-means clustering of the Principal Components, it can be observed that while plotting the components that explain a high variability of the data, humidity and temperature appear in opposite directions, hence confirming their negative correlation with each other. \newline
Also, when we consider the 3 clusters in the plot of PC1 against PC2, which cumulatively explain approx. $72\%$ of our data, we can observe that the darkest cluster (represented by 1.0) represents values that contain high values of height, incident PAR and reflected PAR and relatively high values of temperature, leading to lower values of relative humidity. The second cluster (represented by 2.0) -> Lower values of height with higher temperature, higher incident PAR, higher reflect PAR and lower humidity. Third cluster (represented by 3.0) -> lower values of height, higher humidity, lower temperature, lower incident and reflected PAR.
```{r k means PCA}
#Try grouping and checking over the week
comp = data.frame(pca_prcomp$x)
wss = function(k) {
  kmeans(comp,algorithm="Lloyd", k, nstart = 10, iter.max=200 )$tot.withinss
}

k.values <- 1:5
wss_values <- map_dbl(k.values, wss)
plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
# 3?
kmeans_pca = kmeans(comp,3)
fviz_pca(pca_prcomp, axes = c(1, 2),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(1, 3),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(1, 4),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(1, 5),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(2, 3),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(2, 4),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(2, 5),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(3, 4),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(3, 5),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
fviz_pca(pca_prcomp, axes = c(4, 5),geom=c("point"),col.ind = kmeans_pca$clust,col.var="red",alpha.ind=0.25)
```

```{r may-count}
data_all <- read_csv("data/data-all-dates-locations.csv") %>%
  select(-c("...1"))
data_all %>%
  filter(as.Date(epochDates) >= as.Date("2004-05-01") & as.Date(epochDates) <= as.Date("2004-05-31")) %>%
  nrow()
```

78.2% of data is within May, 2004

```{r count-Times}
data_all_sun <- read_csv("data/may-data-sun.csv")
data_all_sun$Time <- factor(data_all_sun$Time, levels = c("Early Night", "Late Night", "Sunrise", "Early Morning", "Late Morning", "Early Noon", "Late Noon", "Sunset"))
data_all_sun %>%
  count(Time)
```

### Time vs Variable Boxplots

```{r boxplots}
ggplot(data_all_sun, aes(x=Time, y=hamatop, group=Time)) +
  geom_boxplot()

ggplot(data_all_sun, aes(x=Time, y=humid_temp, group=Time)) +
  geom_boxplot()

ggplot(data_all_sun, aes(x=Time, y=humid_adj, group=Time)) +
  geom_boxplot()
```

### Clustering

```{r clust-initial-plot}
data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  ggplot(., aes(x=humid_adj, y=humid_temp, color=Time)) +
  geom_point() +
  labs(title="Early Night vs Early Noon", x="Humidity", y="Temperature")
```

```{r clustering-1}
library(mclust)
set.seed(521)

gmm1 <- data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  select(humid_adj, humid_temp) %>%
  Mclust(., G=5, modelNames="VVV", prior=priorControl())

clusters_data_1 <- data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  select(humid_adj, humid_temp) %>%
  cbind(., gmm1$classification)

names(clusters_data_1)[3] <- "Cluster"
clusters_data_1$Cluster <- as.factor(clusters_data_1$Cluster)

ggplot(clusters_data_1, aes(x=humid_adj, y=humid_temp, color=Cluster)) +
  geom_point() +
  labs(title="GMM Clustering", x="Humidity", y="Temperature")
```

Cluster 1 = Early Noon, Cluster 2 = Early Night, Cluster 3 = Early Night, Cluster 4 = Early Noon, Cluster 5 = Early Night

```{r cluster-accuracy}
clusters_real_data <- data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  select(humid_adj, humid_temp, Time, Hour, Day, Height) %>%
  cbind(., gmm1$classification)
names(clusters_real_data)[7] <- "Cluster"
clusters_real_data$Cluster <- as.factor(clusters_real_data$Cluster)

acc1 <- clusters_real_data %>%
  filter(Cluster == 1) %>%
  count(Time) %>%
  summarise(X1 = 100*n[2]/sum(n))

acc2 <- clusters_real_data %>%
  filter(Cluster == 2) %>%
  count(Time) %>%
  summarise(X2 = 100*n[1]/sum(n))

acc3 <- clusters_real_data %>%
  filter(Cluster == 3) %>%
  count(Time) %>%
  summarise(X3 = 100*n[1]/sum(n))

acc4 <- clusters_real_data %>%
  filter(Cluster == 4) %>%
  count(Time) %>%
  summarise(X4 = 100*n[2]/sum(n))

acc5 <- clusters_real_data %>%
  filter(Cluster == 5) %>%
  count(Time) %>%
  summarise(X5 = 100*n[1]/sum(n))
```

Cluster 1 = Early Noon, Cluster 2 = Early Night, Cluster 3 = Early Night, Cluster 4 = Early Noon, Cluster 5 = Early Night

```{r gmm-means}
gmm_means <- rbind(cbind(acc1, acc2, acc3, acc4, acc5), data.frame(gmm1$parameters$mean))
names(gmm_means) <- c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4", "Cluster 5")
rownames(gmm_means) <- c("Accuracy %", "Humidity Mean", "Temperature Mean")
gmm_means %>%
  kbl(digits = 3, caption = "GMM Accuracy and Cluster Means") %>%
  kable_styling(latex_options = "HOLD_position", full_width = F)
```

Clusters 4 and 5 both have low humidity and high temperature but cluster 4 represents early noon while cluster 5 represents early night. Cluster 3 has high humidity and low temperature while cluster 5 has low humidity and high temperature but both represent early night.

```{r gmm-hist-comparisons}
clusters_real_data %>%
  filter(Cluster == 4 | Cluster == 5) %>%
  ggplot(., aes(x=Hour, fill=Time)) +
  geom_bar() +
  labs(title="Clusters 4 & 5 Histogram by Hour", y="# of Observations")

clusters_real_data %>%
  filter(Cluster == 4 | Cluster == 5) %>%
  ggplot(., aes(x=Height, fill=Time)) +
  geom_histogram(position="fill", binwidth=5) +
  labs(title="Clusters 4 & 5 Histogram by Height", y="Proportion of Observations")

clusters_real_data %>%
  filter(Cluster == 3 | Cluster == 5) %>%
  ggplot(., aes(x=Day, fill=Cluster)) +
  geom_bar(position="fill") +
  labs(title="Clusters 3 & 5 Histogram by Day", y="Proportion of Observations")

clusters_real_data %>%
  filter(Cluster == 3 | Cluster == 5) %>%
  ggplot(., aes(x=Height, fill=Cluster)) +
  geom_histogram(position="fill", binwidth=5) +
  labs(title="Clusters 3 & 5 Histogram by Height", y="Proportion of Observations")
```

## 5

### a)

get rid of 0s and say why

```{r 5a}
i_par_plot <- data_all %>%
  mutate(hamatop = case_when(
    hamatop == 0 ~ 1,
    T ~ hamatop
  )) %>%
  ggplot(., aes(x=log(hamatop))) +
  geom_histogram(aes(y = (..count..)/sum(..count..)),binwidth=0.5) +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Incident PAR", x="log \u00b5mol/m\u00b2/s", y="Percentage of readings")

r_par_plot <- data_all %>%
  mutate(hamabot = case_when(
    hamabot == 0 ~ 1,
    T ~ hamabot
  )) %>%
  ggplot(., aes(x=log(hamabot))) +
  geom_histogram(aes(y = (..count..)/sum(..count..)),binwidth=0.5) +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Reflected PAR", x="log \u00b5mol/m\u00b2/s", y="Percentage of readings")

grid.arrange(i_par_plot, r_par_plot, nrow=1)
```

### b)

```{r 5b-1}
p_3c_1 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_temp),
         x2 = quantile(humid_temp, probs=0.25),
         x3 = quantile(humid_temp, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Temperature vs Height", x="Height (m)", y="\u00b0C", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3c_2 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_adj),
         x2 = quantile(humid_adj, probs=0.25),
         x3 = quantile(humid_adj, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Relative Humidity vs Height", x="Height (m)", y="%RH", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3c_3 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(hamatop),
         x2 = quantile(hamatop, probs=0.25),
         x3 = quantile(hamatop, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Incident PAR vs Height", x="Height (m)", y="\u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3c_4 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(hamabot),
         x2 = quantile(hamabot, probs=0.25),
         x3 = quantile(hamabot, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Reflected PAR vs Height", x="Height (m)", y="\u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

grid.arrange(p_3c_1, p_3c_2, p_3c_3, p_3c_4, nrow=2, ncol=2)
```

```{r 5b-2}
p_3d_1 <- data_all %>%
  mutate(humid_temp = humid_temp - mean(humid_temp)) %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_temp),
         x2 = quantile(humid_temp, probs=0.25),
         x3 = quantile(humid_temp, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Temperature vs Height", x="Height (m)", y="Mean Centered \u00b0C", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3d_2 <- data_all %>%
  mutate(humid_adj = humid_adj - mean(humid_adj)) %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_adj),
         x2 = quantile(humid_adj, probs=0.25),
         x3 = quantile(humid_adj, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Relative Humidity vs Height", x="Height (m)", y="Mean Centered %RH", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3d_3 <- data_all %>%
  mutate(hamatop = hamatop - mean(hamatop)) %>%
  group_by(Height) %>%
  mutate(x1 = median(hamatop),
         x2 = quantile(hamatop, probs=0.25),
         x3 = quantile(hamatop, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Incident PAR vs Height", x="Height (m)", y="Mean Centered \u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3d_4 <- data_all %>%
  mutate(hamabot = hamabot - mean(hamabot)) %>%
  group_by(Height) %>%
  mutate(x1 = median(hamabot),
         x2 = quantile(hamabot, probs=0.25),
         x3 = quantile(hamabot, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Reflected PAR vs Height", x="Height (m)", y="Mean Centered \u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

grid.arrange(p_3d_1, p_3d_2, p_3d_3, p_3d_4, nrow=2, ncol=2)
```

### c)

add height to legend labels

```{r 5c-1}
library(lubridate)
data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Temperature` = mean(humid_temp)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Temperature`) %>%
  arrange(., desc(`Mean Temperature`)) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Temperature` = mean(humid_temp)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Temperature`) %>%
  arrange(., `Mean Temperature`) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Temperature` = mean(humid_temp)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Temperature`) %>%
  arrange(., `Mean Temperature`) %>%
  slice(26:28)

data_all %>%
  filter((as.Date(epochDates) == as.Date("2004-05-01")) & (nodeid == 118 | nodeid == 20 | nodeid == 11)) %>%
  mutate(nodeid = factor(nodeid),
         Time = format(epochDates, "%H:%M")) %>%
  ggplot(., aes(x=Time)) +
  geom_point(aes(y=humid_temp, color=nodeid)) +
  geom_line(aes(y=humid_temp, group=nodeid, color=nodeid)) +
  scale_x_discrete(breaks=c("00:00", "06:00", "12:00", "18:00", "23:30")) +
  labs(title="May 1 Temperature vs Time", y="Temperature (\u00b0C)", color="Node id")
```

```{r 5c-2}
library(lubridate)
data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Humidity` = mean(humid_adj)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Humidity`) %>%
  arrange(., desc(`Mean Humidity`)) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Humidity` = mean(humid_adj)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Humidity`) %>%
  arrange(., `Mean Humidity`) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Humidity` = mean(humid_adj)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Humidity`) %>%
  arrange(., `Mean Humidity`) %>%
  slice(26:28)

data_all %>%
  filter((as.Date(epochDates) == as.Date("2004-05-01")) & (nodeid == 20 | nodeid == 17 | nodeid == 115)) %>%
  mutate(nodeid = factor(nodeid),
         Time = format(epochDates, "%H:%M")) %>%
  ggplot(., aes(x=Time)) +
  geom_point(aes(y=humid_adj, color=nodeid)) +
  geom_line(aes(y=humid_adj, group=nodeid, color=nodeid)) +
  scale_x_discrete(breaks=c("00:00", "06:00", "12:00", "18:00", "23:30")) +
  labs(title="May 1 Relative Humidity vs Time", y="%RH", color="Node id")
```

### d)

114980 network observations

putting net and log on same graphs for 1,2,3

```{r 5d-net-merges}
data_net <- merge(data_net, dates, by = "epoch", all.x = T, suffixes = c(".net", ".dates"))
data_net <- merge(data_net, locations, by = "nodeid", all.x = T, suffixes = c(".net", ".locations"))
```

```{r 5d-net-yields-dates}
net_dates_yield <- c()
dates_range <- c()
nodes_per <- c()
for (date in as.list(unique(as.Date(dates$epochDates)))) {
  date_yield <- data_net %>%
    filter(as.Date(epochDates) == as.Date(date) & !is.na(voltage)) %>%
    distinct(nodeid) %>%
    nrow()
  net_dates_yield <- c(net_dates_yield, date_yield/nrow(locations))
  
  date_nodes <- data_net %>%
    filter(as.Date(epochDates) == as.Date(date) & !is.na(voltage)) %>%
    distinct(nodeid) %>%
    pull()
  d <- rep(date, length(date_nodes))
  dates_range <- c(dates_range, d)
  nodes_per <- c(nodes_per, date_nodes)
}

yields_dates <- dates %>%
  distinct(as.Date(epochDates)) %>%
  cbind(., net_dates_yield)
names(yields_dates) <- c("Day", "Yield")

yields_dates %>%
  ggplot(., aes(x=100*Yield)) +
  geom_bar(aes(y = 100*(..count..)/sum(..count..))) +
  labs(title="Per Day Yields", x="Yield %", y="% of Days")

yields_dates %>%
  ggplot(., aes(x=Day, y=100*Yield)) +
  geom_point() +
  geom_line() +
  labs(title="Per Day Yields", y="Yield %")

data.frame(cbind(dates_range, nodes_per)) %>%
  merge(., locations, by.x="nodes_per", by.y="nodeid", all.x=T) %>%
  mutate(Height = as.numeric(Height),
         dates_range = as.Date(dates_range, origin="1970-01-01")) %>%
  ggplot(., aes(x=dates_range, y=Height)) +
  geom_point()
```

```{r 5d-net-yields-2}
net_nodes_yield <- c()
for (node_id in locations$nodeid) {
  node_yield <- data_net %>%
    filter(nodeid == node_id & !is.na(voltage)) %>%
    distinct(as.Date(epochDates)) %>%
    nrow()
  net_nodes_yield <- c(net_nodes_yield, node_yield/length(unique(as.Date(dates$epochDates))))
}

yields_nodes <- locations %>%
  mutate(Height = as.numeric(Height)) %>%
  distinct(nodeid, Height) %>%
  cbind(., net_nodes_yield)
names(yields_nodes) <- c("Node ID", "Height", "Yield")

yields_nodes %>%
  ggplot(., aes(x=100*Yield)) +
  geom_bar(aes(y = 100*(..count..)/sum(..count..))) +
  labs(title="Per Node Yields", x="Yield %", y="% of Nodes")

yields_nodes %>%
  ggplot(., aes(x=100*Yield, y=Height)) +
  geom_point() +
  labs(title="Per Node Yields", x="Yield %", y="Node Height (m)")
```
