---
title: "Project 1"
author: "Sanskriti Purohit & Caleb Woo"
date: "2022-10-13"
output: pdf_document
---

```{r chunk-options}
knitr::opts_chunk$set(message = F, warning = F)
```

```{r libraries-data}
library(tidyverse)
library(dplyr)
library(chron)
library(lubridate)
library(ggcorrplot)
library(RColorBrewer)
library(scales)
data_net <- read.csv("data/sonoma-data-net.csv")
data_log <- read.csv("data/sonoma-data-log.csv")
dates <- read_csv("data/dates.csv")
dates <- dates %>%
  select(-c("...1"))
```

## 2.

### a)

Voltage

```{r initial-voltage}
data_net %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=25) +
  labs(title="Network ADC Histogram", x="ADC", y="Count")

data_log %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Logs Voltage Histogram", x="Voltage", y="Count")
```

Voltage is inconsistent, link below for ADC to voltage conversion

  - http://www-db.ics.uci.edu/pages/research/quasar/MPR-MIB%20Series%20User%20Manual%207430-0021-06_A.pdf
  
  - page 23 (25 of pdf) has MICA2DOT conversion

```{r fixed-voltage}
data_net <- data_net %>%
  mutate(voltage = 0.6*(1024/voltage))

data_net %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Network Voltage Histogram", x="Voltage", y="Count")

data_log %>%
  ggplot(data=., aes(x=voltage)) +
  geom_histogram(binwidth=0.25) +
  labs(title="Logs Voltage Histogram", x="Voltage", y="Count")
```

Humidity

```{r humidity}
data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  select(humidity) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  select(humidity) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4 & humidity < 105) %>%
  select(humidity) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  select(humidity) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4 & humidity < 105) %>%
  ggplot(data=., aes(x=humidity)) +
  geom_histogram(bins=20) +
  labs(title="Network Humidity Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humidity) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humidity)) +
  geom_histogram(bins=20) +
  labs(title="Logs Humidity Histogram", x="Humidity", y="Count")
```

Adjusted Humidity

```{r adj-humidity}
data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_adj) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_adj) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4 & humid_adj < 105) %>%
  select(humid_adj) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_adj) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4 & humid_adj < 105) %>%
  ggplot(data=., aes(x=humid_adj)) +
  geom_histogram(bins=20) +
  labs(title="Network Adjusted Humidity Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humid_adj) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humid_adj)) +
  geom_histogram(bins=20) +
  labs(title="Logs Adjusted Humidity Histogram", x="Humidity", y="Count")
```

Temperature

```{r temperature}
data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_temp) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_temp) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4 & humid_temp < 35) %>%
  select(humid_temp) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  select(humid_temp) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4 & humid_temp < 35) %>%
  ggplot(data=., aes(x=humid_temp)) +
  geom_histogram(bins=15) +
  labs(title="Network Temperature Histogram", x="Humidity", y="Count")

data_log %>%
  filter(!is.na(humid_temp) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=humid_temp)) +
  geom_histogram(bins=15) +
  labs(title="Logs Temperature Histogram", x="Humidity", y="Count")
```

Incident PAR

```{r initial-hamatop}
data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  max()
```

Hamatop is inconsistent, link below for Lux to PPFD conversion

  - https://www.apogeeinstruments.com/conversion-ppfd-to-lux/

```{r fixed-hamatop}
data_net <- data_net %>%
  mutate(hamatop=0.0185*hamatop)

data_log <- data_log %>%
  mutate(hamatop=0.0185*hamatop)

data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamatop) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4 & hamatop < 2200) %>%
  select(hamatop) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Network Incident PAR Histogram", x="Incident PAR", y="Count")

data_log %>%
  filter(!is.na(hamatop) & voltage <= 3 & voltage >= 2.4  & hamatop < 2200) %>%
  ggplot(data=., aes(x=hamatop)) +
  geom_histogram(bins=20) +
  labs(title="Logs Incident PAR Histogram", x="Incident PAR", y="Count")
```

Reflected PAR

```{r initial-hamabot}
data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  min()

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  min()

data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()
```

Fix hamabot like hamatop

```{r fixed-hamabot}
data_net <- data_net %>%
  mutate(hamabot=0.0185*hamabot)

data_log <- data_log %>%
  mutate(hamabot=0.0185*hamabot)

data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  select(hamabot) %>%
  pull() %>%
  max()

data_net %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=hamabot)) +
  geom_histogram(bins=15) +
  labs(title="Network Reflected PAR Histogram", x="Reflected PAR", y="Count")

data_log %>%
  filter(!is.na(hamabot) & voltage <= 3 & voltage >= 2.4) %>%
  ggplot(data=., aes(x=hamabot)) +
  geom_histogram(bins=15) +
  labs(title="Logs Reflected PAR Histogram", x="Reflected PAR", y="Count")
```

### b)

```{r dates-merge}
data_both <- merge(data_net, data_log, by = c("epoch", "nodeid"), all.y = T, suffixes = c(".net", ".log"))
data_all <- merge(data_both, dates, by = "epoch", all.x = T)
```

```{r missing}
missing_data <-  data_all %>%
  select(ends_with(".log"), epochDates, epochDays) %>%
  filter_all(any_vars(is.na(.)))
  #filter(is.na(parent.log) | is.na(voltage.log) | is.na(depth.log) | is.na(humidity.log) | is.na(humid_temp.log) |
  #       is.na(humid_adj.log) | is.na(hamatop.log) | is.na(hamabot.log))

paste0("# of missing measurements: ", nrow(missing_data))

missing_data %>%
  select(epochDates) %>%
  summarise(min = min(epochDates),
            max = max(epochDates))
```

```{r remove-missing}
data_all <- data_all %>%
  filter(!is.na(parent.log) & !is.na(voltage.log) & !is.na(depth.log) & !is.na(humidity.log) & !is.na(humid_temp.log) &
         !is.na(humid_adj.log) & !is.na(hamatop.log) & !is.na(hamabot.log))
row.names(data_all) <- NULL
```

### c)

```{r locations}
locations <- read_csv("data/locations.csv") %>%
  select(-c("...1"))
```

```{r locations-merge}
data_all <- merge(data_all, locations, by = "nodeid", all.x = T)
```

The network data and logs data have identical columns in this merged data frame except for voltage. This must be because network voltage data had to be converted from ADC so the conversion may not be exact. Since network data is missing for some rows, logs data is not missing for any rows, and logs data has identical values as network data (other than voltage but logs voltage is more accurate anyways), we can remove network data columns from the merged data frame. In addition, result_time and epochDates represent the same information with epochDates from sonoma-dates being more accurate, so I will also remove the result_time column from the logs data.

```{r remove-network-data}
data_all <- data_all %>%
  select(-ends_with(".net"), -result_time.log)
names(data_all)[3:11] <- str_replace(names(data_all)[3:11], ".log", "")
names(data_all)
```

There are 16 total variables in my complete merged data frame that includes network and logs data, dates data, and locations data.

```{r remove-missing-locations}
data_all %>%
  filter(is.na(Height) & is.na(Direc) & is.na(Dist) & is.na(Tree)) %>%
  nrow()
data_all <- data_all %>%
  filter(!is.na(Height) & !is.na(Direc) & !is.na(Dist) & !is.na(Tree))
```

6091 missing location observations.

### d)

Since sensors with low batteries were not accurate, we removed all data with voltages greater than 3 and less than 2.4 like Tolle et al. This removed 26011 observations. Below are the quantiles and histograms of each variable after removing the voltages and before removing any other outliers.

```{r voltage-outliers}
data_all %>%
  filter(voltage > 3 | voltage < 2.4) %>%
  nrow()
data_all <- data_all %>%
  filter(voltage <= 3 & voltage >= 2.4)
```

```{r humidity-pre-removal}
quantile(data_all$humidity)

data_all %>%
  ggplot(., aes(x=humidity)) +
  geom_histogram()
```

```{r humid_adj-removal}
quantile(data_all$humid_adj)

data_all %>%
  ggplot(., aes(x=humid_adj)) +
  geom_histogram()
```

The quantiles in humid_adj more closely matches that of Tolle et al. compared to the quantiles of humidity so we should use humid_adj in place of humidity. This allows us to remove 1 more variable so we have a total of 15 variables. There do not seem to be any other outliers in humid_adj.

```{r temp-pre-removal}
quantile(data_all$humid_temp)

data_all %>%
  ggplot(., aes(x=humid_temp)) +
  geom_histogram()
```

The quantiles of temperature match up well with that of Tolle et al. so there does not seem to be any other outliers in temperature.

```{r hamatop-pre-removal}
quantile(data_all$hamatop)

data_all %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram()
```

```{r high-hamatop-nodes}
data_all %>%
  filter(hamatop > 2154) %>%
  select(nodeid) %>%
  unique()
```

There seem to be some abnormally high values of incident PAR and when we look for the nodes that gave a reading higher than the max incident PAR reading of 2154 given in the paper, we see that node 40 is solely responsible for all those readings. So we will remove all observations with node 40. This removes 98 observations. 271,776 observations left.

```{r hamabot-pre-removal}
quantile(data_all$hamabot)

data_all %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram()
```

The quantiles of reflected PAR match up well with that of Tolle et al. so there does not seem to be any other outliers in reflected PAR.

Below are the quantiles and histograms of each variable after removing both the voltages and observations with node 40. 

```{r remove-node-40}
data_all %>%
  filter(nodeid == 40) %>%
  nrow()
data_all <- data_all %>%
  filter(nodeid != 40)
```

```{r humid-adj-post-removal}
quantile(data_all$humid_adj)

data_all %>%
  ggplot(., aes(x=humid_adj)) +
  geom_histogram()
```

```{r temp-post-removal}
quantile(data_all$humid_temp)

data_all %>%
  ggplot(., aes(x=humid_temp)) +
  geom_histogram()
```

```{r hamatop-post-removal}
quantile(data_all$hamatop)

data_all %>%
  ggplot(., aes(x=hamatop)) +
  geom_histogram()
```

```{r hamabot-post-removal}
quantile(data_all$hamabot)

data_all %>%
  ggplot(., aes(x=hamabot)) +
  geom_histogram()
```

All quantiles and histograms of humidity, temperature, incident PAR, and reflected PAR match up well with the quantiles of Tolle et al. after removing observations with voltages greater than 3 and less than 2.4 and removing observations with node 40.

```{r write-csv-data-all}
data_all %>%
  filter_all(any_vars(is.na(.))) %>%
  nrow()

#write.csv(data_all, "data/data-all-dates-locations.csv")
```

```{r}
#Checking for further outliers
data_all %>%
  ggplot(., aes(x=voltage))+geom_boxplot()
data_all %>%
  ggplot(., aes(x=humid_temp))+geom_boxplot()
```

## 3.

### a)
```{r}
data_all = read.csv("data/data-all-dates-locations.csv")
data_all %>%
  select(epochDates) %>%
  summarise(
    min = min(epochDates),
    max = max(epochDates)
  )

data_all$Date = as.Date(data_all$epochDates)
data_all$time = format(as.POSIXct(data_all$epochDates), format = "%H:%M")
data_all$dayofweek = wday(data_all$epochDates)
data_all$hour = format(as.POSIXct(data_all$epochDates), format = "%H")
data_all$hour = as.numeric(data_all$hour)
# data_all$Height = as.numeric(data_all$Height) #Check this
#Reason for choosing the hours for Dark and Light
data_all %>% 
  ggplot(aes(x=hour,y=hamatop)) + geom_point()
data_all$Sunlight = case_when(
  as.numeric(data_all$hour) <= 5 | as.numeric(data_all$hour) >= 20  ~ "Dark",
  as.numeric(data_all$hour) < 20 ~ "Light"
)
count(data_all,Sunlight)

date_count = data_all %>% 
  count(Date)
date_count$n = date_count$n*100/sum(date_count$n)
p=0
for(i in 1:length(date_count$n)){
  p = p + date_count$n[i]
  date_count$n[i] = p
}
date_count$n
data_all = data_all %>%
  filter(Date > '2004-04-27' & Date < '2004-05-27')
data_all %>%
  select(epochDates) %>%
  summarise(
    min = min(epochDates),
    max = max(epochDates)
  )
count(data_all,Sunlight)

#Add more?
data_all %>% 
  ggplot(aes(x=humid_temp, y=humid_adj, col = Sunlight)) + geom_point()
data_all %>% 
  ggplot(aes(x=hour,y=hamatop)) + geom_point()
data_all %>%
  ggplot(aes(x=hour,y=hamatop, col=Height)) + geom_point()
data_all %>%
  ggplot(aes(x=humid_temp,y=hamatop)) + geom_point()
data_all %>% 
  ggplot(aes(x=humid_adj,y=hamabot, col = Sunlight)) + geom_point()
data_all %>% 
  ggplot(aes(x=humid_temp,y=hamabot, col=Sunlight)) + geom_point()
#Abnormal values of reflected ray at odd hours at higher levels of heights.
data_all %>% 
  ggplot(aes(x=hour,y=hamabot)) + geom_point()
```
## 3
### b)
```{r}
#Positive correlation only between hamatop and hamabot?
corr = round(x=cor(data_all[,unlist(lapply(data_all,is.numeric))],y=data_all$hamatop, method=c("pearson","kendall","spearman")))
ggcorrplot(corr,method="square")
```

### c)
```{r}
data_all %>%
  ggplot(aes(x=Date,y=hamatop,col=Height)) + geom_point()
data_all %>%
  ggplot(aes(x=Date,y=hamabot,col=Height)) + geom_point()
data_all %>%
  ggplot(aes(x=Date,y=humid_adj,col=Height)) + geom_point()
data_all %>%
  ggplot(aes(x=Date,y=humid_temp,col=Height)) + geom_point()
```
### d)
```{r}
names(data_all)
cols_name = c("hamatop","hamabot","Height","hour","dayofweek","humid_temp","humid_adj")
data_filtered = data_all |>
  select(all_of(cols_name)) |>
  data.frame()
pca_prcomp = prcomp(data_filtered, scale. = TRUE)
summary(pca_prcomp)
eigenvalues = pca_prcomp$sdev**2
plot(1:length(eigenvalues), eigenvalues/sum(eigenvalues), type = "l")
points(1:length(eigenvalues), eigenvalues/sum(eigenvalues))
```

## 4

```{r k means PCA}
comp = data.frame(pca_prcomp$x)
wss = function(k) {
  kmeans(comp,algorithm="Lloyd", k, nstart = 10, iter.max=200 )$tot.withinss
}
k.values <- 1:7
wss_values <- map_dbl(k.values, wss)
plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")
# 3?
kmeans_pca = kmeans(comp,3)
palette(alpha(brewer.pal(9,'Set1'), 0.5))
plot(comp, col=kmeans_pca$clust, pch=16)
```

```{r may-count}
data_all %>%
  filter(as.Date(epochDates) >= as.Date("2004-05-01") & as.Date(epochDates) <= as.Date("2004-05-31")) %>%
  nrow()
```

78.2% of data is within May, 2004

```{r count-Times}
library(tidyverse)
data_all_sun <- read_csv("data/may-data-sun.csv")
data_all_sun$Time <- factor(data_all_sun$Time, levels = c("Early Night", "Late Night", "Sunrise", "Early Morning", "Late Morning", "Early Noon", "Late Noon", "Sunset"))
data_all_sun %>%
  count(Time)
```

### Time vs Variable Boxplots

```{r boxplots}
ggplot(data_all_sun, aes(x=Time, y=hamatop, group=Time)) +
  geom_boxplot()

ggplot(data_all_sun, aes(x=Time, y=humid_temp, group=Time)) +
  geom_boxplot()

ggplot(data_all_sun, aes(x=Time, y=humid_adj, group=Time)) +
  geom_boxplot()
```

### Clustering

```{r clust-initial-plot}
data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  ggplot(., aes(x=humid_adj, y=humid_temp, color=Time)) +
  geom_point() +
  labs(title="Early Night vs Early Noon", x="Humidity", y="Temperature")
```

```{r clustering-1}
library(mclust)
set.seed(521)

gmm1 <- data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  select(humid_adj, humid_temp) %>%
  Mclust(., G=5, modelNames="VVV", prior=priorControl())

clusters_data_1 <- data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  select(humid_adj, humid_temp) %>%
  cbind(., gmm1$classification)

names(clusters_data_1)[3] <- "Cluster"
clusters_data_1$Cluster <- as.factor(clusters_data_1$Cluster)

ggplot(clusters_data_1, aes(x=humid_adj, y=humid_temp, color=Cluster)) +
  geom_point() +
  labs(title="GMM Clustering", x="Humidity", y="Temperature")
```

Cluster 1 = Early Noon, Cluster 2 = Early Night, Cluster 3 = Early Night, Cluster 4 = Early Noon, Cluster 5 = Early Night

```{r cluster-accuracy}
library(kableExtra)

clusters_real_data <- data_all_sun %>%
  filter(Time == "Early Night" | Time == "Early Noon") %>%
  select(humid_adj, humid_temp, Time, Hour, Day, Height) %>%
  cbind(., gmm1$classification)
names(clusters_real_data)[7] <- "Cluster"
clusters_real_data$Cluster <- as.factor(clusters_real_data$Cluster)

acc1 <- clusters_real_data %>%
  filter(Cluster == 1) %>%
  count(Time) %>%
  summarise(X1 = 100*n[2]/sum(n))

acc2 <- clusters_real_data %>%
  filter(Cluster == 2) %>%
  count(Time) %>%
  summarise(X2 = 100*n[1]/sum(n))

acc3 <- clusters_real_data %>%
  filter(Cluster == 3) %>%
  count(Time) %>%
  summarise(X3 = 100*n[1]/sum(n))

acc4 <- clusters_real_data %>%
  filter(Cluster == 4) %>%
  count(Time) %>%
  summarise(X4 = 100*n[2]/sum(n))

acc5 <- clusters_real_data %>%
  filter(Cluster == 5) %>%
  count(Time) %>%
  summarise(X5 = 100*n[1]/sum(n))
```

Cluster 1 = Early Noon, Cluster 2 = Early Night, Cluster 3 = Early Night, Cluster 4 = Early Noon, Cluster 5 = Early Night

```{r gmm-means}
gmm_means <- rbind(cbind(acc1, acc2, acc3, acc4, acc5), data.frame(gmm1$parameters$mean))
names(gmm_means) <- c("Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4", "Cluster 5")
rownames(gmm_means) <- c("Accuracy %", "Humidity Mean", "Temperature Mean")
gmm_means %>%
  kbl(digits = 3, caption = "GMM Accuracy and Cluster Means") %>%
  kable_styling(latex_options = "HOLD_position", full_width = F)
```

Clusters 4 and 5 both have low humidity and high temperature but cluster 4 represents early noon while cluster 5 represents early night. Cluster 3 has high humidity and low temperature while cluster 5 has low humidity and high temperature but both represent early night.

```{r gmm-hist-comparisons}
clusters_real_data %>%
  filter(Cluster == 4 | Cluster == 5) %>%
  ggplot(., aes(x=Hour, fill=Time)) +
  geom_bar()

clusters_real_data %>%
  filter(Cluster == 4 | Cluster == 5) %>%
  ggplot(., aes(x=Day, fill=Time)) +
  geom_bar(position="fill")

clusters_real_data %>%
  filter(Cluster == 4 | Cluster == 5) %>%
  ggplot(., aes(x=Height, fill=Time)) +
  geom_histogram(position="fill", binwidth=5)

clusters_real_data %>%
  filter(Cluster == 3 | Cluster == 5) %>%
  ggplot(., aes(x=Day, fill=Cluster)) +
  geom_bar(position="fill")

clusters_real_data %>%
  filter(Cluster == 3 | Cluster == 5) %>%
  ggplot(., aes(x=Height, fill=Cluster)) +
  geom_histogram(position="fill", binwidth=5)

clusters_real_data %>%
  filter((Cluster == 3 | Cluster == 5) & (Day == 11 | Day == 12)) %>%
  ggplot(., aes(x=Height, fill=Cluster)) +
  geom_histogram(position="fill", binwidth=5)
```

### Incident PAR

```{r glm}
library(stats)
normal_glm <- glm(hamatop ~ humid_temp + humid_adj + Height + Time, family = gaussian(), data = data_all_sun)
summary(normal_glm)
```

```{r glm-diagnostics}
plot(normal_glm)
```

## 5

### a)

```{r 5-data}
library(tidyverse)
library(gridExtra)
data_all <- read_csv("data/data-all-dates-locations.csv")
```

```{r 5a}
i_par_plot <- data_all %>%
  mutate(hamatop = case_when(
    hamatop == 0 ~ 1,
    T ~ hamatop
  )) %>%
  ggplot(., aes(x=log(hamatop))) +
  geom_histogram(aes(y = (..count..)/sum(..count..)),binwidth=0.5) +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Incident PAR", x="log \u00b5mol/m\u00b2/s", y="Percentage of readings")

r_par_plot <- data_all %>%
  mutate(hamabot = case_when(
    hamabot == 0 ~ 1,
    T ~ hamabot
  )) %>%
  ggplot(., aes(x=log(hamabot))) +
  geom_histogram(aes(y = (..count..)/sum(..count..)),binwidth=0.5) +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Reflected PAR", x="log \u00b5mol/m\u00b2/s", y="Percentage of readings")

grid.arrange(i_par_plot, r_par_plot, nrow=1)
```

### b)

```{r 5b-1}
p_3c_1 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_temp),
         x2 = quantile(humid_temp, probs=0.25),
         x3 = quantile(humid_temp, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Temperature vs Height", x="Height (m)", y="\u00b0C", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3c_2 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_adj),
         x2 = quantile(humid_adj, probs=0.25),
         x3 = quantile(humid_adj, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Relative Humidity vs Height", x="Height (m)", y="%RH", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3c_3 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(hamatop),
         x2 = quantile(hamatop, probs=0.25),
         x3 = quantile(hamatop, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Incident PAR vs Height", x="Height (m)", y="\u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3c_4 <- data_all %>%
  group_by(Height) %>%
  mutate(x1 = median(hamabot),
         x2 = quantile(hamabot, probs=0.25),
         x3 = quantile(hamabot, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Reflected PAR vs Height", x="Height (m)", y="\u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

grid.arrange(p_3c_1, p_3c_2, p_3c_3, p_3c_4, nrow=2, ncol=2)
```

```{r 5b-2}
p_3d_1 <- data_all %>%
  mutate(humid_temp = humid_temp - mean(humid_temp)) %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_temp),
         x2 = quantile(humid_temp, probs=0.25),
         x3 = quantile(humid_temp, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Temperature vs Height", x="Height (m)", y="Mean Centered \u00b0C", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3d_2 <- data_all %>%
  mutate(humid_adj = humid_adj - mean(humid_adj)) %>%
  group_by(Height) %>%
  mutate(x1 = median(humid_adj),
         x2 = quantile(humid_adj, probs=0.25),
         x3 = quantile(humid_adj, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Relative Humidity vs Height", x="Height (m)", y="Mean Centered %RH", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3d_3 <- data_all %>%
  mutate(hamatop = hamatop - mean(hamatop)) %>%
  group_by(Height) %>%
  mutate(x1 = median(hamatop),
         x2 = quantile(hamatop, probs=0.25),
         x3 = quantile(hamatop, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Incident PAR vs Height", x="Height (m)", y="Mean Centered \u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

p_3d_4 <- data_all %>%
  mutate(hamabot = hamabot - mean(hamabot)) %>%
  group_by(Height) %>%
  mutate(x1 = median(hamabot),
         x2 = quantile(hamabot, probs=0.25),
         x3 = quantile(hamabot, probs=0.75)) %>%
  distinct(Height, x1, x2, x3) %>%
  ggplot(., aes(x=Height)) +
  geom_point(aes(y=x1, color="Median"), alpha=0.5) +
  geom_line(aes(y=x1), color="red", alpha=0.5) +
  geom_point(aes(y=x2, color="25%"), alpha=0.5) +
  geom_line(aes(y=x2), color="blue", alpha=0.5) +
  geom_point(aes(y=x3, color="75%"), alpha=0.5) +
  geom_line(aes(y=x3), color="green", alpha=0.5) +
  labs(title="Reflected PAR vs Height", x="Height (m)", y="Mean Centered \u00b5mol/m\u00b2/s", color="Quantile") +
  scale_color_manual(values=c("Median"="red", "25%"="blue", "75%"="green"))

grid.arrange(p_3d_1, p_3d_2, p_3d_3, p_3d_4, nrow=2, ncol=2)
```

### c)

```{r 5c-1}
library(lubridate)
data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Temperature` = mean(humid_temp)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Temperature`) %>%
  arrange(., desc(`Mean Temperature`)) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Temperature` = mean(humid_temp)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Temperature`) %>%
  arrange(., `Mean Temperature`) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Temperature` = mean(humid_temp)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Temperature`) %>%
  arrange(., `Mean Temperature`) %>%
  slice(26:28)

data_all %>%
  filter((as.Date(epochDates) == as.Date("2004-05-01")) & (nodeid == 118 | nodeid == 20 | nodeid == 11)) %>%
  mutate(nodeid = factor(nodeid),
         Time = format(epochDates, "%H:%M")) %>%
  ggplot(., aes(x=Time)) +
  geom_point(aes(y=humid_temp, color=nodeid)) +
  geom_line(aes(y=humid_temp, group=nodeid, color=nodeid)) +
  scale_x_discrete(breaks=c("00:00", "06:00", "12:00", "18:00", "23:30")) +
  labs(title="May 1 Temperature vs Time", y="Temperature (\u00b0C)", color="Node id")
```

```{r 5c-2}
library(lubridate)
data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Humidity` = mean(humid_adj)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Humidity`) %>%
  arrange(., desc(`Mean Humidity`)) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Humidity` = mean(humid_adj)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Humidity`) %>%
  arrange(., `Mean Humidity`) %>%
  slice(1:3)

data_all %>%
  filter(as.Date(epochDates) == as.Date("2004-05-01")) %>%
  group_by(nodeid) %>%
  mutate(`Mean Humidity` = mean(humid_adj)) %>%
  ungroup() %>%
  distinct(nodeid, `Mean Humidity`) %>%
  arrange(., `Mean Humidity`) %>%
  slice(26:28)

data_all %>%
  filter((as.Date(epochDates) == as.Date("2004-05-01")) & (nodeid == 20 | nodeid == 17 | nodeid == 115)) %>%
  mutate(nodeid = factor(nodeid),
         Time = format(epochDates, "%H:%M")) %>%
  ggplot(., aes(x=Time)) +
  geom_point(aes(y=humid_adj, color=nodeid)) +
  geom_line(aes(y=humid_adj, group=nodeid, color=nodeid)) +
  scale_x_discrete(breaks=c("00:00", "06:00", "12:00", "18:00", "23:30")) +
  labs(title="May 1 Relative Humidity vs Time", y="%RH", color="Node id")
```

### d)

114980 network observations

```{r 5d-net-merges}
data_net <- merge(data_net, dates, by = "epoch", all.x = T, suffixes = c(".net", ".dates"))
data_net <- merge(data_net, locations, by = "nodeid", all.x = T, suffixes = c(".net", ".locations"))
```

```{r 5d-net-yields-dates}
net_dates_yield <- c()
dates_range <- c()
nodes_per <- c()
for (date in as.list(unique(as.Date(dates$epochDates)))) {
  date_yield <- data_net %>%
    filter(as.Date(epochDates) == as.Date(date) & !is.na(voltage)) %>%
    distinct(nodeid) %>%
    nrow()
  net_dates_yield <- c(net_dates_yield, date_yield/nrow(locations))
  
  date_nodes <- data_net %>%
    filter(as.Date(epochDates) == as.Date(date) & !is.na(voltage)) %>%
    distinct(nodeid) %>%
    pull()
  d <- rep(date, length(date_nodes))
  dates_range <- c(dates_range, d)
  nodes_per <- c(nodes_per, date_nodes)
}

yields_dates <- dates %>%
  distinct(as.Date(epochDates)) %>%
  cbind(., net_dates_yield)
names(yields_dates) <- c("Day", "Yield")

yields_dates %>%
  ggplot(., aes(x=100*Yield)) +
  geom_bar(aes(y = 100*(..count..)/sum(..count..))) +
  labs(title="Per Day Yields", x="Yield %", y="% of Days")

yields_dates %>%
  ggplot(., aes(x=Day, y=100*Yield)) +
  geom_point() +
  geom_line() +
  labs(title="Per Day Yields", y="Yield %")

data.frame(cbind(dates_range, nodes_per)) %>%
  merge(., locations, by.x="nodes_per", by.y="nodeid", all.x=T) %>%
  mutate(Height = as.numeric(Height),
         dates_range = as.Date(dates_range, origin="1970-01-01")) %>%
  ggplot(., aes(x=dates_range, y=Height)) +
  geom_point()
```

```{r 5d-net-yields-2}
net_nodes_yield <- c()
for (node_id in locations$nodeid) {
  node_yield <- data_net %>%
    filter(nodeid == node_id & !is.na(voltage)) %>%
    distinct(as.Date(epochDates)) %>%
    nrow()
  net_nodes_yield <- c(net_nodes_yield, node_yield/length(unique(as.Date(dates$epochDates))))
}

yields_nodes <- locations %>%
  mutate(Height = as.numeric(Height)) %>%
  distinct(nodeid, Height) %>%
  cbind(., net_nodes_yield)
names(yields_nodes) <- c("Node ID", "Height", "Yield")

yields_nodes %>%
  ggplot(., aes(x=100*Yield)) +
  geom_bar(aes(y = 100*(..count..)/sum(..count..))) +
  labs(title="Per Node Yields", x="Yield %", y="% of Nodes")

yields_nodes %>%
  ggplot(., aes(x=100*Yield, y=Height)) +
  geom_point() +
  labs(title="Per Node Yields", x="Yield %", y="Node Height (m)")
```

